#!/usr/bin/env ruby

# The ultimate awesome Nodejs packaging tool like a supernova!

require 'fileutils'
require_relative 'dependencies.rb'
include Dependencies

name = ARGV[0]

# generate dependency map, downloadable filelist, and complete license string
Dependencies.write(name)

# generate source.txt

# start from 1, 0 will the be 'phantomjs.json'
i = 1

if File.exists?(name + '.lst')
    open(name + '.source','w:UTF-8') do |f|
	open(name + '.lst','r:UTF-8') do |f1|
		f1.each_line do |l|
			arr = l.strip.split(";")
			url = "http://registry.npmjs.org/" + arr[0] + "/-/" + arr[1] + ".tgz"
			f.write "Source" + i.to_s + ":\t" + url + "\n"
			i += 1
		end
	end
    end
end

# download sources
if File.exists?(name + '.lst')
    open(name + '.lst','r:UTF-8') do |f|
		f.each_line do |l|
			arr = l.strip.split(";")
			url = "http://registry.npmjs.org/" + arr[0] + "/-/" + arr[1] + ".tgz"
			IO.popen("wget --tries=0 #{url}")
		end
    end
    FileUtils.rm_rf name + '.lst'
end

